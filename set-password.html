<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Passwort setzen</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.17.11/dist/css/uikit.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/uikit@3.17.11/dist/js/uikit.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/uikit@3.17.11/dist/js/uikit-icons.min.js"></script>
</head>
<body>

<div class="uk-section uk-section-small uk-flex uk-flex-middle uk-flex-center" style="min-height:100vh;">
  <div class="uk-container uk-container-xsmall">
    <div class="uk-card uk-card-default uk-card-body">
      <h3 class="uk-card-title">Neues Passwort setzen</h3>
      <form id="pwForm" class="uk-form-stacked">
        <div class="uk-margin">
          <label class="uk-form-label">Neues Passwort</label>
          <div class="uk-form-controls">
            <input class="uk-input" type="password" id="newPassword" required minlength="6" />
          </div>
        </div>
        <div class="uk-margin">
          <button class="uk-button uk-button-primary uk-width-1-1" type="submit">Speichern</button>
        </div>
      </form>
      <div id="result" class="uk-margin-top uk-text-center"></div>
    </div>
  </div>
</div>

<script>
  const API_BASE = 'https://cloud-backend-2-ttrb.onrender.com';
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get('token');

  const resultDiv = document.getElementById('result');
  const form = document.getElementById('pwForm');

  if (!token) {
    form.style.display = 'none';
    resultDiv.innerHTML = `
      <div class="uk-alert-danger" uk-alert>
        <p>Kein Token übergeben – Link ungültig.</p>
      </div>`;
  }

  form.addEventListener('submit', async function (e) {
    e.preventDefault();
    const password = document.getElementById('newPassword').value;

    try {
      const res = await fetch(`${API_BASE}/set-password`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token, password })
      });

      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err?.error || 'Unbekannter Fehler');
      }

      form.style.display = 'none';
      resultDiv.innerHTML = `
        <div class="uk-alert-success" uk-alert>
          <p>Passwort wurde gespeichert. Du kannst dich jetzt <a href="index.html">anmelden</a>.</p>
        </div>`;
    } catch (err) {
      resultDiv.innerHTML = `
        <div class="uk-alert-danger" uk-alert>
          <p>${err.message}</p>
        </div>`;
    }
  });
</script>

</body>
</html>
